# 相关概念

- Cache line ：缓存行，缓存的最小操作单元
- CAS（Compare and Swap）：比较并交换

# 处理器实现原子操作

1. 使用总线锁：使用处理器提供的一个`LOCK#`信号，当一个处理器在总线上输出此信号时，其他处理器的请求将被阻塞住
2. 使用缓存锁：总线锁的开销较大，频繁使用的内存会缓存在处理器的高速缓存里，原子操作可以直接在处理器内部缓存中进行，利用缓存一致性来保证操作的原子性

# Java 实现原子操作

1. 通过锁：锁机制保证了只有获得锁的线程才能够操作锁定的内存区域
2. 通过循环 CAS：循环进行 CAS 操作直到成功为止，从 Java 1.5 开始，JDK 的并发包里提供了一些类来支持原子操作（如 AtomicBoolean，AtomicInteger，AtomicLong 等）

# CAS 实现原子操作的三大问题

1. ABA 问题：如果一个值原来是 A，变成了 B，又变成了 A，那么使用 CAS 检查时会发现其值没有发生改变，但实际上改变了
   - 解决思路：在变量前面追加版本号，每次变量更新的时候把版本号加1
2. 循环时间长：自旋 CAS 如果长时间不成功，会给 CPU 带来非常大的执行开销
   - 解决思路：JVM 支持处理器提供的`pause`指令
3. 只能保证一个共享变量的原子操作：循环 CAS 无法保证多个共享变量的原子操作
   - 解决思路：使用锁；从 Java 1.5 开始，JDK 提供了 AtomicReference 类来保证引用对象之间的原子性，就可以把多个变量放在一个对象里来进行 CAS 操作