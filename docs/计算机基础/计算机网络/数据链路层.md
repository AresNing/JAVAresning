# 基本概念

## 链路与数据链路

- **链路（Link）**：从一个结点到相邻结点的一段物理线路，而中间无任何其他交换结点
- **数据链路（Data Link）**：把实现通信协议的硬件和软件加到链路上，构成数据链路
- 数据链路层是**以帧为单位**传输和处理数据

## 使用点对点信道的三个重要问题

> 针对点对点信道的数据链路层

- 封装成帧

![以太网V2的MAC帧](pics/image-20210928101238288.png)

- 差错检测
- 可靠传输：无论发送方发送什么内容，接收方都能接收到什么

## 使用广播信道

- 共享式以太网的媒体接入控制协议 CSMA/CD
- 802.11 局域网的媒体接入控制协议 CSMA/CA

## 数据链路层的互连设备

- 网桥
- 交换机
- 集线器（物理层互连设备）与交换机的区别

# 封装成帧

- 封装成帧：数据链路层给上层交付的协议数据单元（PDU）**添加帧头和帧尾使之成为帧**

![封装成帧](pics/image-20210928102207176.png)

## 帧头帧尾

- 帧头帧尾包含重要的控制信息，**作用之一为帧定界**
  - **以太网 V2 的 MAC 帧**通过物理层在**头部加入前导码**
  - **PPP帧**的帧头和帧尾各含有一个字节的**标志位**

![MAC帧和PPP帧](pics/image-20210928102140614.png)

## 透明传输

- **透明传输**：**数据链路层对上层交付的传输数据没有任何限制**，仿佛数据链路层不存在
- **面向字节**的链路：使用**字节填充（或称字符填充）**的方法实现透明传输
  - 在协议数据单元内的标志位/转义字符（Data Link Escape，DLE）前添加转义字符
- **面向比特**的链路：使用**比特填充**的方法实现透明传输
  - “零比特填充法”：在协议数据单元内，每`5`个连续`1`后面插入一个比特`0`

## 最大传送单元 MTU

- 为了提高帧的传输效率，帧的数据部分的长度应该尽可能大
- **最大传送单元（Maximum Transfer Unit，MTU）**：每一种数据链路层协议都规定了**帧的数据部分的长度上限**

# 差错检测

- **误码率（Bit Error Rate）**：在一段时间内，传输错误比特占所传输比特总数的比率
- 奇偶校验：在待发送的数据后面添加**1位奇偶校验位**，使整个数据（包括所添加的校验位在内）中“1”的个数为奇数（奇校验）或偶数（偶校验）
- **检错码**只能检测出帧在传输出现了差错，但**不能定位错误，无法纠正错误**

## 循环冗余校验 CRC

- Cyclic Redundancy Check，CRC

1. 收发双方约定好一个**生成多项式 G(x)**
2. 发送方基于待发送的数据和生成多项式计算出差错检测码（**冗余码**），将其添加到待传输数据的后面一起传输
3. 接收方通过生成多项式来计算收到的数据是否产生误码

![CRC具体过程](pics/image-20210928104611086.png)

- 循环冗余校验 CRC 有很好的检错能力，易于用应将实现，被广泛应用于数据链路层

# 可靠传输

## 基本概念

- **不可靠传输**服务：仅仅丢弃有误码的帧，不做其他处理
- **可靠传输**服务：发送端发送什么，接收端就收到什么
- 一般情况下，**有线链路**的误码率较低，**不要求数据链路层**向上提供**可靠**传输服务
- **无线链路**易受干扰，误码率较高，**要求数据链路层**必须先上层提供可靠传输服务
- **可靠传输服务并不局限于数据链路层**，其它各层均可选择实现可靠传输
- 传输差错：**比特差错**、**分组丢失**、**分组失序**、**分组重复**

## 停止-等待协议 SW

### 基本概念

- 停止-等待协议，Stop-and Wait，SW
- ACK：Acknowledge character，确认字符
- NAK：Negative Acknowledge，否认字符

![停止-等待协议SW](pics/image-20210928135010348.png)

### 注意事项

- 接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传，或**给发送方发送 NAK 分组**
- **数据分组编号**：为了让接收方能够判断所收到的数据分组是否重复；由于停止-等待协议的停等特性，**只需1个比特编号即可，即编号0和1**
- **ACK 分组编号**：为了让发送方能够判断收到的 ACK 分组是否重复，**所用比特数量与数据分组相同**
  - 数据链路层一般不会出现 ACK 分组迟到的情况，因此在**数据链路层实现停止-等待协议可以不用给 ACK 分组编号**
- 超时计时器设置的**重传时间**一般选为**略大于“从发送方到接收方的平均往返时间”**
- 自动请求重传（Automatic Repeat reQuest，ARQ）

### 信道利用率

![停止-等待协议的信道利用率](pics/image-20210928140141921.png)

- **当往返时间 RTT 远大于数据帧发送时延$T_D$时（e.g. 卫星链路），信道利用率非常低**
- 若出现重传，则对于传送有用的数据信息而言，信道利用率还要降低

## 回退 N 帧协议 GBN

### 基本概念

![回退N帧协议GBN](pics/image-20210928140840889.png)

- 连续 ARQ 协议
- 滑动窗口协议
- 由于回退 N 帧协议的特性，当通信线路质量不好时，其信道利用率并不比停止-等待协议高

### 发送方

- **发送窗口$W_T$的取值范围：$1<W_T\leq2^n-1$，其中$n$是构成分组序号的比特数量**
  - $W_T=1$：停止-等待协议
  - $W_T>2^n-1$：接收方无法分辨新、旧数据分组
- 发送方可在未收到接收方确认分组的情况下，将序号落在发送窗口内的多个数据分组全部发送出去
- **发送方只有收到对已发送数据分组的确认时，发送窗口才能向前相应滑动**
- 发送方收到多个重复确认时，可在重传计时器超时前尽早开始重传
- **回退 N 帧**：发送方发送窗口内某个已发送的数据分组产生超时重发时，其后续在发送窗口内且已发送的数据分组也必须全部重传

### 接收方

- **接收方的接收窗口尺寸$W_R$的取值范围：$W_R=1$，即接收方只能按序接收数据分组**
- 接收方只接受序号落在接受窗口内且无误码的数据分组，并且将接收窗口向前滑动一个位置，同时给发送方发回相应的确认分组
  - **累计确认**：为减少开销，接收方可以在连续收到多个按序到达且无误码的数据分组后，才针对最后一个数据发送确认分组$ACK_n$
  - 或者可以在自己有数据分组要发送时才对之前按序接收且无误码的数据分组进行捎带确认
- 接收方收到未按序到达的数据分组，除丢弃外，还要对最近按序接收的数据分组进行确认

## 选择重传协议 SR

### 基本概念

![选择重传协议SR](pics/image-20210928150000886.png)

- **GBN 的缺点**：GBN 的接收窗口尺寸$W_R$只能为1，一个数据分组的误码会导致后续多个数据分组不能被接收方按序接收而丢弃，造成通信资源浪费
- 选择重传协议（Selective Request，SR）：为了使发送方仅重传出现差错的分组，**接收方不能再采用累积确认**，而需要对每个正确接收到的数据分组进行**逐一确认**

### 发送方

- **发送窗口$W_T$的取值范围：$1<W_T\leq2^{n-1}$，其中$n$是构成分组序号的比特数量**
  - $W_T=1$：停止-等待协议
  - $W_T>2^{n-1}$：接收方无法分辨新、旧数据分组
- 发送方可在未收到接收方确认分组的情况下，将序号落在发送窗口内的多个数据分组全部发送出去
- **发送方只有收到对已发送数据分组的确认时，发送窗口才能向前相应滑动**
- **若收到未按序到达的确认分组时，对其进行记录，以防止其相应数据分组的超时重发，但发送窗口不能向前滑动**

### 接收方

- **接收方的接收窗口尺寸$W_R$的取值范围：$1<W_R\leq W_T$**
  - $W_R=1$：回退 N 帧协议
  - $W_R>W_T$：无意义
- 接收方可接收未按序到达但没有误码且序号落在接收窗口内的数据分组
- 为了使发送方仅重传出现差错的分组，**接收方不能再采用累积确认**，而需要对每个正确接收到的数据分组进行**逐一确认**
- 接收方只有在按序接收数据分组后，接收窗口才能向前相应滑动









